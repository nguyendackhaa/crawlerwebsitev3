<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HopLong Crawler - Haiphongtech.vn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>

<body class="bg-light">
    <div class="container py-4">
        <div class="card mb-3">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">HopLong Product Crawler</h3>
                    <div class="text-muted">Cào dữ liệu hoplongtech.com theo danh mục và hãng</div>
                </div>
                <div>
                    <a class="btn btn-outline-secondary" href="/">Trang chủ</a>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">1) Chọn danh mục</div>
            <div class="card-body">
                <div class="row g-2 align-items-center">
                    <div class="col-md-8">
                        <select id="categorySelect" class="form-select">
                            <option value="">-- Đang tải danh mục... --</option>
                        </select>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="reloadCategories" class="btn btn-secondary">Tải lại danh mục</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">2) Chọn danh mục con</div>
            <div class="card-body">
                <div class="row g-2 align-items-center">
                    <div class="col-md-8">
                        <div id="subcategoryContainer" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="loadSubcategories" class="btn btn-success">Tải danh mục con</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">3) Chọn hãng sản xuất</div>
            <div class="card-body">
                <div class="row g-2 align-items-center">
                    <div class="col-md-8">
                        <div id="brandContainer" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="loadBrands" class="btn btn-info">Tải hãng</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">4) Thiết lập & Bắt đầu</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Số luồng</label>
                        <input id="maxWorkers" type="number" class="form-control" value="10" min="1" max="32">
                    </div>
                    <div class="col-md-9 d-flex align-items-end justify-content-end gap-2">
                        <button id="startBtn" class="btn btn-primary">Bắt đầu cào</button>
                        <button id="resultsBtn" class="btn btn-outline-primary">Xem kết quả</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="progressCard" class="card mb-3" style="display:none;">
            <div class="card-header">Tiến trình</div>
            <div class="card-body">
                <div class="progress mb-2">
                    <div id="progressBar" class="progress-bar" style="width:0%">0%</div>
                </div>
                <div id="progressMessage" class="fw-semibold">Sẵn sàng...</div>
                <div id="progressDetail" class="text-muted small"></div>
            </div>
        </div>

        <div id="errorCard" class="card mb-3" style="display:none;">
            <div class="card-header bg-danger text-white">Lỗi</div>
            <div class="card-body">
                <div id="errorMessage" class="fw-semibold text-danger"></div>
                <div id="errorDetails" class="text-muted small mt-2" style="display:none;">
                    <strong>Chi tiết lỗi:</strong>
                    <pre class="bg-light p-2 mt-1" style="font-size:12px; max-height:200px; overflow-y:auto;"></pre>
                </div>
                <div class="mt-2">
                    <button id="showErrorDetails" class="btn btn-sm btn-outline-danger">Xem chi tiết</button>
                    <button id="hideError" class="btn btn-sm btn-secondary">Ẩn</button>
                </div>
            </div>
        </div>

        <div id="successCard" class="card mb-3" style="display:none;">
            <div class="card-header bg-success text-white">Thành công</div>
            <div class="card-body">
                <div id="successMessage" class="fw-semibold text-success"></div>
                <div id="successStats" class="text-muted small mt-2"></div>
                <div class="mt-2">
                    <button id="hideSuccess" class="btn btn-sm btn-secondary">Ẩn</button>
                </div>
            </div>
        </div>

        <div id="resultsCard" class="card" style="display:none;">
            <div class="card-header">Kết quả gần đây</div>
            <div class="card-body" id="resultsContainer"></div>
        </div>
    </div>

    <script>
        let socket = null;
        document.addEventListener('DOMContentLoaded', () => {
            socket = io();
            socket.on('progress_update', (data) => updateProgress(data.percent, data.message, data.detail || ''));
            socket.on('crawler_completed', (data) => {
                updateProgress(100, data.message || 'Hoàn thành', '');
                loadResults();
                showSuccessMessage(data.message || 'Cào dữ liệu hoàn thành!', data.stats);
            });
            socket.on('crawler_error', (data) => {
                showErrorMessage(data.message || 'Có lỗi xảy ra trong quá trình cào dữ liệu', data.error_details);
                updateProgress(0, 'Lỗi', data.message || '');
            });

            document.getElementById('reloadCategories').addEventListener('click', loadCategories);
            document.getElementById('loadSubcategories').addEventListener('click', loadSubcategories);
            document.getElementById('loadBrands').addEventListener('click', loadBrands);
            document.getElementById('startBtn').addEventListener('click', startCrawl);
            document.getElementById('resultsBtn').addEventListener('click', loadResults);

            // Error và Success card event listeners
            document.getElementById('showErrorDetails').addEventListener('click', () => {
                const details = document.getElementById('errorDetails');
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            });
            document.getElementById('hideError').addEventListener('click', () => {
                document.getElementById('errorCard').style.display = 'none';
            });
            document.getElementById('hideSuccess').addEventListener('click', () => {
                document.getElementById('successCard').style.display = 'none';
            });

            loadCategories();
            loadResults();
        });

        async function loadCategories() {
            const sel = document.getElementById('categorySelect');
            sel.innerHTML = '<option value="">-- Đang tải danh mục... --</option>';
            try {
                const resp = await fetch('/hoplong/categories');
                const data = await resp.json();
                sel.innerHTML = '<option value="">-- Chọn danh mục --</option>';
                (data.categories || []).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.url; opt.textContent = c.name;
                    sel.appendChild(opt);
                });
            } catch (e) {
                sel.innerHTML = '<option value="">-- Lỗi tải danh mục --</option>';
            }
        }

        async function loadSubcategories() {
            const sel = document.getElementById('categorySelect');
            const url = sel.value;
            const box = document.getElementById('subcategoryContainer');
            box.innerHTML = '';
            if (!url) {
                alert('Vui lòng chọn danh mục chính trước');
                return;
            }

            box.innerHTML = '<span class="text-info">Đang tải danh mục con...</span>';

            try {
                const resp = await fetch('/hoplong/subcategories?category=' + encodeURIComponent(url));
                const data = await resp.json();
                box.innerHTML = '';

                if (!data.success) {
                    box.innerHTML = '<span class="text-danger">Lỗi: ' + (data.message || 'Không thể tải danh mục con') + '</span>';
                    return;
                }

                (data.subcategories || []).forEach(sc => {
                    const lbl = document.createElement('label');
                    lbl.className = 'btn btn-outline-primary btn-sm';
                    lbl.style.marginRight = '6px';
                    lbl.style.marginBottom = '6px';

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = sc.url;
                    cb.className = 'me-1';

                    lbl.appendChild(cb);
                    lbl.appendChild(document.createTextNode(sc.name + ' (' + sc.product_count + ')'));
                    box.appendChild(lbl);
                });

                if ((data.subcategories || []).length === 0) {
                    box.innerHTML = '<span class="text-warning">Không tìm thấy danh mục con nào.</span>';
                }
            } catch (e) {
                box.innerHTML = '<span class="text-danger">Lỗi tải danh mục con: ' + e.message + '</span>';
            }
        }

        async function loadBrands() {
            const selectedSubcategories = getSelectedSubcategories();
            const box = document.getElementById('brandContainer');
            box.innerHTML = '';

            if (selectedSubcategories.length === 0) {
                alert('Vui lòng chọn ít nhất một danh mục con trước');
                return;
            }

            box.innerHTML = '<span class="text-info">Đang tải hãng sản xuất...</span>';

            try {
                // Lấy brands từ subcategory đầu tiên (có thể mở rộng sau)
                const firstSubcategory = selectedSubcategories[0];
                const resp = await fetch('/hoplong/brands?category=' + encodeURIComponent(firstSubcategory));
                const data = await resp.json();
                box.innerHTML = '';

                if (!data.success) {
                    box.innerHTML = '<span class="text-danger">Lỗi: ' + (data.message || 'Không thể tải hãng') + '</span>';
                    return;
                }

                (data.brands || []).forEach(b => {
                    const lbl = document.createElement('label');
                    lbl.className = 'btn btn-outline-secondary btn-sm';
                    lbl.style.marginRight = '6px';
                    lbl.style.marginBottom = '6px';

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = b;
                    cb.className = 'me-1';

                    lbl.appendChild(cb);
                    lbl.appendChild(document.createTextNode(b));
                    box.appendChild(lbl);
                });

                if ((data.brands || []).length === 0) {
                    box.innerHTML = '<span class="text-warning">Không tìm thấy hãng nào.</span>';
                }
            } catch (e) {
                box.innerHTML = '<span class="text-danger">Lỗi tải hãng: ' + e.message + '</span>';
            }
        }

        function getSelectedSubcategories() {
            return Array.from(document.querySelectorAll('#subcategoryContainer input[type=checkbox]:checked')).map(x => x.value);
        }

        function getSelectedBrands() {
            return Array.from(document.querySelectorAll('#brandContainer input[type=checkbox]:checked')).map(x => x.value);
        }

        async function startCrawl() {
            const category = document.getElementById('categorySelect').value;
            const subcategories = getSelectedSubcategories();
            const brands = getSelectedBrands();
            const maxWorkers = parseInt(document.getElementById('maxWorkers').value || '10', 10);

            if (!category) { alert('Chọn danh mục chính'); return; }
            if (!subcategories.length) { alert('Chọn ít nhất 1 danh mục con'); return; }
            if (!brands.length) { alert('Chọn ít nhất 1 hãng'); return; }

            document.getElementById('progressCard').style.display = 'block';
            updateProgress(0, 'Bắt đầu...', '');

            // Gửi subcategories thay vì category chính
            const resp = await fetch('/crawl-hoplong', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category: subcategories[0], // Sử dụng subcategory đầu tiên
                    subcategories: subcategories,
                    brands: brands,
                    max_workers: maxWorkers
                })
            });
            const data = await resp.json();
            if (!data.success) alert(data.message || 'Lỗi khởi chạy crawler');
        }

        async function loadResults() {
            const box = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            card.style.display = 'block';
            box.innerHTML = 'Đang tải...';
            try {
                const resp = await fetch('/list-hoplong-results');
                const data = await resp.json();
                if (!data.success) { box.innerHTML = 'Lỗi tải kết quả'; return; }
                const arr = data.results || [];
                if (!arr.length) { box.innerHTML = 'Chưa có kết quả.'; return; }
                let html = '';
                arr.forEach(r => {
                    html += `<div class="border rounded p-3 mb-2 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-semibold">${r.folder_name}</div>
                            <div class="text-muted small">Categories: ${r.category_count} | Products: ${r.product_count} | Images: ${r.image_count} | Created: ${r.created_time}</div>
                        </div>
                        <a class="btn btn-sm btn-success" href="/download-hoplong-result/${r.folder_name}">Tải ZIP</a>
                    </div>`;
                });
                box.innerHTML = html;
            } catch (e) {
                box.innerHTML = 'Lỗi kết nối.';
            }
        }

        function updateProgress(p, m, d) {
            const bar = document.getElementById('progressBar');
            const msg = document.getElementById('progressMessage');
            const det = document.getElementById('progressDetail');
            bar.style.width = (p || 0) + '%';
            bar.textContent = Math.round(p || 0) + '%';
            msg.textContent = m || '';
            det.textContent = d || '';
        }

        function showErrorMessage(message, errorDetails) {
            const errorCard = document.getElementById('errorCard');
            const errorMessage = document.getElementById('errorMessage');
            const errorDetailsDiv = document.getElementById('errorDetails');
            const errorDetailsPre = errorDetailsDiv.querySelector('pre');

            errorMessage.textContent = message;

            if (errorDetails) {
                errorDetailsPre.textContent = errorDetails;
                document.getElementById('showErrorDetails').style.display = 'inline-block';
            } else {
                document.getElementById('showErrorDetails').style.display = 'none';
            }

            errorDetailsDiv.style.display = 'none';
            errorCard.style.display = 'block';

            // Ẩn success card nếu đang hiển thị
            document.getElementById('successCard').style.display = 'none';
        }

        function showSuccessMessage(message, stats) {
            const successCard = document.getElementById('successCard');
            const successMessage = document.getElementById('successMessage');
            const successStats = document.getElementById('successStats');

            successMessage.textContent = message;

            if (stats) {
                let statsText = `Danh mục xử lý: ${stats.categories_processed || 0}, `;
                statsText += `Hãng xử lý: ${stats.brands_processed || 0}, `;
                statsText += `Sản phẩm tìm thấy: ${stats.products_found || 0}, `;
                statsText += `Sản phẩm xử lý: ${stats.products_processed || 0}`;
                if (stats.errors > 0) {
                    statsText += `, Lỗi: ${stats.errors}`;
                }
                successStats.textContent = statsText;
            } else {
                successStats.textContent = '';
            }

            successCard.style.display = 'block';

            // Ẩn error card nếu đang hiển thị
            document.getElementById('errorCard').style.display = 'none';
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>